name: Reusable Playwright Tests for D10

on:
  workflow_call:
    inputs:
      enabled_modules:
        description: 'Space-separated list of modules to enable (e.g., "du_banners du_functional_testing")'
        required: true
        type: string
      test_tags:
        description: 'Playwright test tags to run (e.g., "@banners")'
        required: true
        type: string
      profile_ref:
        description: 'Optional ref (branch/tag/SHA) of drupal-composer-managed to use'
        required: false
        type: string
        default: ''
    secrets:
      MS_TEAMS_FAILED_TEST_RUN_WEBHOOK_URL:
        description: 'MS Teams webhook URL for failure notifications'
        required: true

jobs:
  playwright:
    runs-on: ubuntu-22.04
    env:
      PLAYWRIGHT_BASE_URL: https://drupal-composer-managed.ddev.site

    steps:
      - name: Checkout module
        uses: actions/checkout@v4
        with:
          path: module

      - name: Checkout Drupal upstream
        uses: actions/checkout@v4
        with:
          repository: DU-University-Relations/drupal-composer-managed
          path: upstream
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: ${{ inputs.profile_ref }}

      - name: Setup DDEV
        uses: ddev/github-action-setup-ddev@v1
        with:
          ddevDir: upstream

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Get module name from repository
        id: module_info
        run: |
          MODULE_NAME=$(basename ${{ github.repository }})
          echo "module_name=$MODULE_NAME" >> $GITHUB_OUTPUT

      - name: Copy module to upstream
        run: |
          DEST_MODULE_DIR="$GITHUB_WORKSPACE/upstream/web/modules/packages/${{ steps.module_info.outputs.module_name }}"
          mkdir -p "$DEST_MODULE_DIR"
          cp -r "$GITHUB_WORKSPACE/module/"* "$DEST_MODULE_DIR/"

      - name: Install PHP dependencies
        working-directory: upstream
        run: ddev composer install --no-interaction --prefer-dist

      - name: Install Drupal using ducore profile
        working-directory: upstream
        run: ddev drush si ducore -y

      - name: Enable modules
        working-directory: upstream
        run: ddev drush en du_functional_testing ${{ inputs.enabled_modules }} -y

      - name: Install test dependencies and generate roles
        working-directory: upstream/tests
        run: |
          if [ -f package-lock.json ]; then
            npm ci
          else
            npm install
          fi
          npm run generate-roles || true

      - name: Install Playwright browsers (CI)
        working-directory: upstream
        run: npx playwright install --with-deps

      - name: Run Playwright tests
        id: playwright
        working-directory: upstream
        shell: bash
        run: |
          # Use the github reporter and capture output with tee
          npx playwright test --reporter=github --grep "${{ inputs.test_tags }}" 2>&1 | tee test.log
          echo "exit_code=${PIPESTATUS[0]}" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: Extract Failure Message
        id: extract
        if: steps.playwright.outputs.exit_code != '0'
        working-directory: upstream
        run: |
          # Extract the first error annotation from the log
          ERROR_MSG=$(grep "^::error" test.log | sed -E 's/^::error.*:://' | head -n 1)
          
          # Fallback if no error found
          if [ -z "$ERROR_MSG" ]; then
            ERROR_MSG="Tests failed, but no specific error annotation was found."
          fi
          
          echo "Captured Error: $ERROR_MSG"
          
          # Write to output using multiline syntax
          echo "error_message<<EOF" >> $GITHUB_OUTPUT
          echo "$ERROR_MSG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Notify MS Teams on failure
        if: steps.playwright.outputs.exit_code != '0'
        uses: DU-University-Relations/.github/.github/actions/ms-teams-notification@main
        with:
          webhook-url: ${{ secrets.MS_TEAMS_FAILED_TEST_RUN_WEBHOOK_URL }}
          failure-info: ${{ steps.extract.outputs.error_message }}

      - name: Upload Playwright report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-d10
          path: upstream/tests/playwright-report
          if-no-files-found: ignore