name: Reusable PHPUnit Tests for D9

on:
  workflow_call:
    inputs:
      test_paths:
        description: 'Space-separated list of paths to test (e.g., "web/profiles/custom web/modules/custom")'
        required: true
        type: string
      phpunit_config:
        description: 'Path to PHPUnit configuration file (e.g., "web/core/phpunit.xml.dist")'
        required: false
        type: string
        default: 'web/core/phpunit.xml.dist'
      profile_ref:
        description: 'Optional ref (branch/tag/SHA) of d9-composer-managed to use'
        required: false
        type: string
        default: ''
    secrets:
      D9_PROFILE_PAT:
        description: 'Personal access token for d9-composer-managed repository'
        required: true
      MS_TEAMS_FAILED_TEST_RUN_WEBHOOK_URL:
        description: 'MS Teams webhook URL for failure notifications'
        required: false

jobs:
  phpunit:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout module
        uses: actions/checkout@v4
        with:
          path: module

      - name: Checkout the Drupal upstream
        uses: actions/checkout@v4
        with:
          repository: DU-University-Relations/d9-composer-managed
          path: upstream
          token: ${{ secrets.D9_PROFILE_PAT }}
          ref: ${{ inputs.profile_ref }}

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.1'
          extensions: gd, pdo_mysql
          coverage: none

      - name: Get module name from repository
        id: module_info
        run: |
          MODULE_NAME=$(basename ${{ github.repository }})
          echo "module_name=$MODULE_NAME" >> $GITHUB_OUTPUT

      - name: Copy module to upstream
        run: |
          DEST_MODULE_DIR="$GITHUB_WORKSPACE/upstream/web/modules/packages/${{ steps.module_info.outputs.module_name }}"
          mkdir -p "$DEST_MODULE_DIR"
          cp -r "$GITHUB_WORKSPACE/module/"* "$DEST_MODULE_DIR/"

      - name: Validate composer.json and composer.lock
        working-directory: upstream
        run: composer validate --strict

      - name: Cache Composer packages
        id: composer-cache
        uses: actions/cache@v3
        with:
          path: upstream/vendor
          key: ${{ runner.os }}-php-${{ hashFiles('upstream/**/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-php-

      - name: Configure Composer to allow plugins
        working-directory: upstream
        run: |
          composer config --no-plugins allow-plugins.simplesamlphp/composer-xmlprovider-installer true
          composer config --no-plugins allow-plugins.phpstan/extension-installer true

      - name: Install PHP dependencies
        working-directory: upstream
        run: composer install --no-interaction --no-progress --prefer-dist --ansi

      - name: Run PHPUnit tests
        working-directory: upstream
        run: |
          vendor/bin/phpunit -c ${{ inputs.phpunit_config }} ${{ inputs.test_paths }}

      - name: Notify MS Teams on failure
        if: failure() && env.WEBHOOK_URL != ''
        env:
          WEBHOOK_URL: ${{ secrets.MS_TEAMS_FAILED_TEST_RUN_WEBHOOK_URL }}
        uses: DU-University-Relations/.github/.github/actions/ms-teams-notification@main
        with:
          webhook-url: ${{ secrets.MS_TEAMS_FAILED_TEST_RUN_WEBHOOK_URL }}
