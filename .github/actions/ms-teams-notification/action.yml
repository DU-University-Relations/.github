name: 'MS Teams Notification'
description: 'Send adaptive card notification to MS Teams webhook'
author: 'DU University Relations'

inputs:
  webhook-url:
    description: 'MS Teams webhook URL'
    required: true
  title:
    description: 'Notification title'
    required: false
    default: 'âŒ Playwright Tests Failed'

runs:
  using: 'composite'
  steps:
    - name: Send MS Teams notification
      shell: bash
      run: |
        # Determine the branch name (use head_ref for PRs, ref_name otherwise)
        BRANCH="${{ github.head_ref }}"
        if [ -z "$BRANCH" ]; then
          BRANCH="${{ github.ref_name }}"
        fi
        
        # Fetch job information to get failure details
        FAILURE_INFO="No failure information available"
        
        # Use GitHub API to fetch job details
        JOBS_RESPONSE=$(curl -s -H "Authorization: token ${{ github.token }}" \
          -H "Accept: application/vnd.github+json" \
          "${{ github.api_url }}/repos/${{ github.repository }}/actions/runs/${{ github.run_id }}/jobs")
        
        # Check if we got a valid response and extract failed job and step information
        if [ -n "$JOBS_RESPONSE" ] && echo "$JOBS_RESPONSE" | jq -e '.jobs' >/dev/null 2>&1; then
          FAILED_JOBS=$(echo "$JOBS_RESPONSE" | jq -r '.jobs[] | select(.conclusion == "failure") | 
            "\(.name): " + (
              [.steps[] | select(.conclusion == "failure") | .name] | 
              if length > 0 then join(", ") else "Job failed" end
            )')
          
          if [ -n "$FAILED_JOBS" ]; then
            FAILURE_INFO="$FAILED_JOBS"
          fi
        fi
        
        # Create JSON payload using jq for proper escaping
        PAYLOAD=$(jq -n \
          --arg title "${{ inputs.title }}" \
          --arg repo "${{ github.repository }}" \
          --arg branch "$BRANCH" \
          --arg failure "$FAILURE_INFO" \
          --arg actor "${{ github.actor }}" \
          --arg workflow "${{ github.workflow }}" \
          --arg url "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" \
          '{
            "type": "message",
            "attachments": [{
              "contentType": "application/vnd.microsoft.card.adaptive",
              "content": {
                "$schema": "http://adaptivecards.io/schemas/adaptive-card.json",
                "type": "AdaptiveCard",
                "version": "1.4",
                "body": [
                  {
                    "type": "TextBlock",
                    "text": $title,
                    "weight": "Bolder",
                    "size": "Large",
                    "color": "Attention"
                  },
                  {
                    "type": "FactSet",
                    "facts": [
                      {
                        "title": "Repository:",
                        "value": $repo
                      },
                      {
                        "title": "Branch:",
                        "value": $branch
                      },
                      {
                        "title": "Failure Info:",
                        "value": $failure
                      },
                      {
                        "title": "Triggered by:",
                        "value": $actor
                      },
                      {
                        "title": "Workflow:",
                        "value": $workflow
                      }
                    ]
                  }
                ],
                "actions": [
                  {
                    "type": "Action.OpenUrl",
                    "title": "View Workflow Run",
                    "url": $url
                  }
                ]
              }
            }]
          }')
        
        # Send notification with error handling
        HTTP_CODE=$(curl --fail --silent --show-error --write-out "%{http_code}" --output /dev/null \
          -H "Content-Type: application/json" \
          -d "$PAYLOAD" \
          "${{ inputs.webhook-url }}")
        
        if [ "$HTTP_CODE" -ne 200 ]; then
          echo "Failed to send MS Teams notification (HTTP $HTTP_CODE)"
          exit 1
        fi
        
        echo "MS Teams notification sent successfully"
